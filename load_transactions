import pandas as pd
from classifications.categories import CHECKING_CATEGORY_MAP

filepath = '/Users/mattray/Desktop/vscode_projects/joint_app/load_transactions'



def load_chase(filename,periods,categories):

    ### Data Intake

    df_list = []

    for p in periods:
        p = p.replace("/", ".")
        df = pd.read_csv(fr'/Users/mattray/Desktop/vscode_projects/joint_app/load_transactions/inputs/{filename}_{p}.csv')
        df_list.append(df)

        # If no files were found, return an empty DataFrame
    if not df_list:
        print("No files were located")
        return pd.DataFrame()

    combined = pd.concat(df_list, ignore_index=True)

    #### Begin Normalization
    df = combined[["Transaction Date", "Post Date", "Description",
        "Category", "Type", "Amount"]]
    
    df = df[~df['Type'].str.contains('Payment',case = False, na=False) ]

    df.loc[df["Description"].str.contains("Kindle Svcs", na=False), "Category"] = "Subscriptions"
    df.loc[df["Description"].str.contains("PETCO", na=False), "Category"] = "Pet Food"
    df.loc[df["Description"].str.contains("FITNESS LEGENDZ", na=False), "Category"] = "Subscriptions"
    df.loc[df["Description"].str.contains("KALSHI", na=False), "Category"] = "Leisure"
    df.loc[df["Description"].str.contains("JD`S BODEGA", na=False), "Category"] = "Leisure"
    df.loc[df["Description"].str.contains("BARBER STORY", na=False), "Category"] = "Subscriptions"

    

    df = df[~df["Description"].str.contains("Zelle payment from Matt Ray", case=False, na=False)]
    df = df[~df["Description"].str.contains("Payment Thank You - Web", case=False, na=False)]


    df["Category"] = df["Category"].replace({
        "Food & Drink": "Leisure",
        "Shopping": "Leisure",
        "Health & Wellness": "Leisure",
        "Entertainment": "Leisure",
        "Bills & Utilities": "Utilities",
        "Travel": "Leisure"
    })
    df["Category"] = df["Category"].str.strip()

    bad = df[~df["Category"].isin(categories)]
    print("Rows NOT in categories list:")
    print(bad[["Description", "Category"]].head(20))

    mask = ~df["Category"].isin(categories)

    df.loc[mask & (df["Amount"] > 0), "Category"] = "Other Income"
    df.loc[mask & (df["Amount"] < 0), "Category"] = "Other Expense"

    return df





def load_sofi(filename,periods,categories):

    ### Data Intake

    df_list = []

    for p in periods:
        p = p.replace("/", ".")
        df = pd.read_csv(fr'/Users/mattray/Desktop/vscode_projects/joint_app/load_transactions/inputs/{filename}_{p}.csv')
        df_list.append(df)

        # If no files were found, return an empty DataFrame
    if not df_list:
        print("No files were located")
        return pd.DataFrame()

    combined = pd.concat(df_list, ignore_index=True)


    ##### Begin Normalization
    df = combined[["Date", "Description", "Type", "Amount"]]
    #df = df[~df["Description"].str.contains("MSPBNA", case=False, na=False)]
    df = df[~df["Description"].str.contains("CHASE CREDIT CRD", case=False, na=False)]
    df = df[~df["Description"].str.contains("Zelle¬Æ Payment from Amy Ray", case=False, na=False)]
    df = df[~df["Description"].str.contains("Payment Thank You - Web", case=False, na=False)]
    df = df[~df["Description"].str.contains("Payment Thank You - Web", case=False, na=False)]
    #df = df[~df["Description"].str.lower().str.contains("coinbase", case=False, na=False)]

    def map_checking_category(row):
        desc = row["Description"]
        amount = row["Amount"]

        # First: check category mappings
        for k, v in CHECKING_CATEGORY_MAP.items():
            if k.upper() in desc.upper():
                return v

        # Otherwise: classify based on amount
        if amount > 0:
            return "Other Income"
        else:
            return "Other Expense"


    df.loc[
        (df["Description"] == "VENMO") & (df["Amount"] > 0),
        "Category"
    ] = "Venmo Income"
    df.loc[
        (df["Description"] == "VENMO") & (df["Amount"] < 0),
        "Category"
    ] = "Venmo Expense"
    df.loc[
        (df["Description"].str.contains("Zelle")) & (df["Amount"] > 0) & (~df["Description"].str.contains("payment to amy ray", case=False, na=False)),
        "Category"
    ] = "Zelle Income"
    df.loc[
        (df["Description"].str.contains("Zelle")) & (df["Amount"] < 0) & (~df["Description"].str.contains("payment to amy ray", case=False, na=False)),
        "Category"
    ] = "Zelle Expense"
    df["Category"] = df.apply(map_checking_category, axis=1)

    mask = ~df["Category"].isin(categories)

    df.loc[mask & (df["Amount"] > 0), "Category"] = "Other Income"
    df.loc[mask & (df["Amount"] < 0), "Category"] = "Other Expense"

    return df
